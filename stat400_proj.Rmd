---
title: "Project_04_24"
author: "Erik Ketterer, Sagan Kakkar, Yamin Zhang, Yining Guan"
date: "2023-04-06"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r}
remove(list = ls())
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(dplyr)
library(haven)
```

# Part1 GML Regression

## Load data
```{r}
fertil2 <- read.csv("data.csv")
```

## Parameter fine-tuning
This data was obtained by James Heakins, a former MSU undergraduate, for a project.  The original data comes from Botswana's 1988 Demographic and Health Survey. 

The response variable/parameter of interest is 'children', the number of living children.  We are trying to predict the number of living children using the explanatory variables 'age', 'urban', 'educ', and 'usemeth', and whether this is an effective model of prediction.  

We want to estimate 'children' by:
  'age', which is the current age in years of mother, 
  'urban', which is 1 if mother lives in urban area, 0 if not
  'educ', which is the number of years of education the mother has
  'usemeth', which is 1 if the mother has ever used birth control and 0 otherwise.
  'agefm', which is age of mother at first marriage.
  
The variables 'age', 'education' and 'agefm' are numerically meaningful, while 'urban' and 'usemeth' are binary.

The variable 'usemeth', and 'agefm' has 2332 NA values in total, which we will omit from the select dataset.

The data are available at website: [Data Resource](https://justinmshea.github.io/wooldridge/reference/fertil2.html#source)
  
```{r}
selectData <- fertil2 %>%
  select(children, age, urban, educ, usemeth, agefm) %>%
  na.omit()
head(selectData)
str(selectData)
```
## Reseach question
### Question 1  
Is the model using parameters 'agefm', 'edu', and 'usemeth' to predict the response variable 'children' efficient?  
### Question 2  
Is the model using parameters 'age', 'edu', and 'urban' to predict the response variable 'children' efficient?  
### Question 3
Which model is better?

## EDA

### univariant
* "children'
```{r}
ggplot(data = selectData, mapping = aes(x = children)) +
  geom_histogram(binwidth = 1, fill = "white", color = "black") +
  labs(x = "Number of Living Children",
       y = "Count")
```

From the graph, we can see the number of children follows right skewed normal distribution with mean value at around 3 and 4. This also indicates that our response variable appears to follow poisson distribution.

* "age"
```{r}
ggplot(data = selectData, mapping = aes(x = age)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Mothers' Age",
       y = "Count")
```

From graph above, the age of mothers seems like to follow normal distribution even if there is a tail on the right side.  

* "urban"
```{r}
ggplot(data = selectData, mapping = aes(x = urban)) + 
  geom_bar(fill = "white", color = "black") +
  labs(x = "Is Urban",
       y = "Count")

#Find the counts of each urban type
table(selectData$urban)

#Find the proportion for urban
prop.table(table(selectData$urban))

```

From the plot and the table above, the number of mothers living in urban area is pretty close to the number of mothers who do not live in urban area.

* "educ'
```{r}
ggplot(data = selectData, mapping = aes(x = educ)) +
  geom_histogram(binwidth = 1.5, fill = "white", color = "black") +
  labs(x = "Mothers' Eduction in Years",
       y = "Count")
```

From the graph, we can see that there are two values (educ=0 and educ=7) in education appearing to be significant large, which means the most of women in Africa have no education or just elementary education.

* "usemeth"
```{r}
ggplot(data = selectData, mapping = aes(x = usemeth)) + 
  geom_bar(fill = "white", color = "black") +
  labs(x = "Is Usemeth",
       y = "Count")

#Find the counts of usemeth
table(selectData$urban)


#Find the proportion for each usemeth type
prop.table(table(selectData$urban))

```

From graph, there seems like a big difference in the number of mother using birth control and the number of mother that does not use birth control.However, in the table we can see that the difference is not significant.

* "agefm'
```{r}
ggplot(data = selectData, mapping = aes(x = agefm)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Age of First Marriage",
       y = "Count")
```

From the graph, the age of first marriage follows normal distribution with mean at 20 and it's right skewed.

### multivariant

```{r}
ggplot(data = selectData, aes(x = age, y = children)) + geom_point() + geom_smooth(method = "lm") + labs(x = "Current Age of Mother", y = "Numbers of Living Children", title = "Relationship between Children and Age")
```

According to the graph, from the smooth line, we can see that the relationship between `age` and `children` is positively related, which means the older the current age of mother is, we can assume the more numbers of living children she had.

```{r}
ggplot(data = selectData, aes(x = educ, y = children)) + geom_point() + facet_grid(.~ urban)+ geom_smooth(method = "lm") + labs(x = "The Years of Education that mother had", y = "Numbers of Living Children", title = "Relationship between Education and Children")
```

According to the graph above, we can see that the the smooth line here is negatively, which mean the relationship between `educ` and `children` is negatively related no matter the mother lived in the urban area or not. In that case, we can say that as the education that the mother had increase, we expect the number of living children that she had decrease.

```{r}
ggplot(data = selectData, aes(x = agefm, y = children)) + geom_boxplot() + facet_grid(. ~ usemeth) + labs(x = "Mother's age at first marriage", y = "Number of Living Children", title = "Relationship between children and age of first marriage")
```

According to the plot above, we can see that the mean numbers of living children that a mother had is roughly same no matter she had ever uses the birth control or not. But the highest number of children that a mother had is come from the group that never uses the birth control. What's more, the range of the numbers of living children is wider in the group that never uses the birth control, which I think we can say the mothers who had used birth control were more in control of their desired number of children.

## Model Fits

```{r}
model1 <- glm(children ~ agefm + educ +usemeth, family = poisson, data = selectData)
summary(model1)
```

```{r}
model2 <- glm(children ~ age + educ + urban, family = poisson, data = selectData)
summary(model2)
```

According to the summary of two models above, we can see that the AIC value for model 2 is relatively low, so here we need to choose the model 2 (represent the first research question). We cannot use the drop-in-deviance method here because these two models are not nested.

## Overdispersion

```{r}
X1 <- sum(residuals(model1, type = "pearson")^2)
phat1 <- X1/model1$df.residual
phat1

X2 <- sum(residuals(model2, type = "pearson")^2)
phat2 <- X2/model2$df.residual
phat2
```

## Goodness of fit test (model 2)

```{r}
#fit the pearson statistics parameters for model 1
X3 <- sum(residuals(model2, type = "pearson")^2)
#calculate the df 
df <- model2$df.residual
#calculate the p-value
pvalue <- 1-pchisq(X3, df)
pvalue
```

We have hypothesis: H0: the model 2 fits , H1: the model 2 does not fit. Since the p-value I get is 0.99, which is relatively high value, in that case we are fail to reject the null hypothesis. In conclusion, according to the p-value we calculated, we prefer the model 2 fits.

## Goodness of fit test (model 1)


```{r}
X4 <- sum(residuals(model1, type = "pearson")^2)
df2<- model1$df.residual
pvalue2 <- 1-pchisq(X4,df2)
pvalue2
```

We have hypothesis: H0: the model 1 fits, H1: the model 1 does not fit. Since the p-value is 0, which is very small, in that case we have evidence that reject the null hypothesis. In conclusion, we prefer the model 1 does not fits.


## Assumption

## Model 1

### Poisson Response
Our response variable is the number of children each mother has. It’s a count value and it can be described by a Poisson Process. From the children data above, it follows right skewed normal distribution, so this also shows it's a Poisson Response.

### Independence
In our project, each observation is a mother, so it is reasonable to assume that each observation is independent to each other.

### Mean = Variance

* 'educ'
```{r}
cuts = cut(selectData$educ,
           breaks=c(-1,5,10,15,20))
educGrps <- data.frame(cuts, selectData)
ggplot(data = educGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children") +
  ylab("Count")
```

```{r}
# Mean = Variance
table1chp4<- educGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each education group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


* 'agefm'

```{r}
cuts = cut(selectData$agefm,
           breaks=c(9, 20, 30, 40, 50))
agefmGrps <- data.frame(cuts, selectData)
ggplot(data = agefmGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children") +
  ylab("Count")
```

```{r}
# Mean = Variance
table1chp4<- agefmGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Educ Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


* 'usemeth'
```{r}
ggplot(data = selectData, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(selectData$usemeth) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- selectData  %>% group_by(usemeth)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each group.",
      col.names = c("Usemeth Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```

* Summary: By looking at the data, some of the graph have too few data to show its distribution, so we don't know if it will follow normal distribution as desired. From the table, we can see that some means and variance are not the same, which means the overdispersion might be a problem.


### Linearity

```{r}
model2 <- glm(children ~ agefm +educ+usemeth, family = 'poisson', data = selectData)
plot(model2, which = 1)
```

From residuals vs. fitted graph, we can see that the fitted line is linear, which means the assumption of linearity is met.

### Model 2

### Poisson Response
Our response variable is the number of children each mother has. It’s a count value and it can be described by a Poisson Process. From the children data above, it follows right skewed normal distribution, so this also shows it's a Poisson Response.

### Independence
In our project, each observation is a mother, so it is reasonable to assume that each observation is independent to each other.

### Mean = Variance

* 'educ'
```{r}
cuts = cut(selectData$educ,
           breaks=c(-1,5,10,15,20))
educGrps <- data.frame(cuts, selectData)
ggplot(data = educGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children") +
  ylab("Count")
```

```{r}
# Mean = Variance
table1chp4<- educGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each education group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```

* 'age'
```{r}
cuts = cut(selectData$age,
           breaks=c(15,20,25,30,35,40,45,50))
ageGrps <- data.frame(cuts, selectData)
ggplot(data = ageGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children") +
  ylab("Count")
```

```{r}
# Mean = Variance
table1chp4<- ageGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)
```


* 'urban'
```{r}
ggplot(data = selectData, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(selectData$urban) +
  xlab("Number of Children") +
  ylab("Count")
```

```{r}
# Mean = Variance
table1chp4<- selectData  %>% group_by(urban)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each group.",
      col.names = c("Urban Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


* Summmary: From the graphs and tables, the mean and variance is not eactly the same for some group of data. Therefore, we need to check the overdispersion problem for this model too.


### Linearity

```{r}
model2 <- glm(children ~ age +educ+urban, family = 'quasipoisson', data = selectData)
plot(model2, which = 1)
```

From the residuals and fitted plot, the fitted line has little curvature, but the curature is very small. I think it's acceptable. Thus, the linearity assumption for model 2 is also met.

## Reaserch Question 1


## Reaserch Question 3 

### Goodness of Fit

# Part2 Multilevel Model

## About data
The dataset we are going to use is created by the people over at the UCLA Institute for Digital Research and Education (IDRE). 
The dataset measures schools and teachers, as well as students. The researchers are interested in how the organizational structure of schools influences the performance of students, or how teacher characteristics such as experience, IQ, or teaching style have an impact on student learning.

Therefore, the level 1 observational unit is each student, and level 2 observational unit is school.

## Load data
```{r}
mlmdata <- read_dta("https://stats.idre.ucla.edu/stat/examples/imm/imm23.dta")
```

## Research Question

Does the time spend on math homework affect the math score?
Does the association between time spent doing homework and math score depend on the type of school?

## Parameter of Interest and Fixed Effect/Random Effect

Therefore, the parameter we are gonna use is 'homework' (Time spend on homework each week) and 'public' (1=public school, 0 = others). And our response variable is 'math'(math score for each student).

Fixed effects are the time spend on their homework and the type of schools.

Random effects are the schools.

## Parameter fine-tuning
We are not going to do any parameter tuning here.
```{r}
head(mlmdata)
str(mlmdata)
```


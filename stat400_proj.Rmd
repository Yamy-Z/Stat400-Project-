---
title: "Project_04_24"
author: "Erik Ketterer, Sagan Kakkar, Yamin Zhang, Yining Guan"
date: "2023-04-06"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r}
remove(list = ls())
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(dplyr)
library(haven)
```

# Part1 GML Regression

## Load data
```{r}
fertil2 <- read.csv("data.csv")
```

## Parameter fine-tuning
This data was obtained by James Heakins, a former MSU undergraduate, for a project.  The original data comes from Botswana's 1988 Demographic and Health Survey. 

The response variable/parameter of interest is 'children', the number of living children.  We are trying to predict the number of living children using the explanatory variables 'age', 'urban', 'educ', and 'usemeth', and whether this is an effective model of prediction.  

We want to estimate 'children' by:
  'age', which is the current age in years of mother, 
  'urban', which is 1 if mother lives in urban area, 0 if not
  'educ', which is the number of years of education the mother has
  'usemeth', which is 1 if the mother has ever used birth control and 0 otherwise.
  'agefm', which is age of mother at first marriage.
  
The variables 'age', 'education' and 'agefm' are numerically meaningful, while 'urban' and 'usemeth' are binary.

The variable 'usemeth', and 'agefm' has 2332 NA values in total, which we will omit from the select dataset.

The data are available at website: [Data Resource](https://justinmshea.github.io/wooldridge/reference/fertil2.html#source)
  
```{r}
selectData <- fertil2 %>%
  select(children, age, urban, educ, usemeth, agefm) %>%
  na.omit()
head(selectData)
str(selectData)
```
## Reseach question
### Question 1  
Is the model using parameters 'agefm', 'edu', and 'usemeth' to predict the response variable 'children' efficient?  
### Question 2  
Is the model using parameters 'age', 'edu', and 'urban' to predict the response variable 'children' efficient?  
### Question 3
Which model is better?

## EDA

### univariant
* "children'
```{r}
ggplot(data = selectData, mapping = aes(x = children)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Number of Living Children",
       y = "Count")
```

* "age"
```{r}
ggplot(data = selectData, mapping = aes(x = age)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Mothers' Age",
       y = "Count")
```
* "urban"
```{r}
ggplot(data = selectData, mapping = aes(x = urban)) + 
  geom_bar(fill = "white", color = "black") +
  labs(x = "Is Urban",
       y = "Count")

#Find the counts of each urban type
table(selectData$urban)
#Find the proportion for each audience type
prop.table(table(selectData$urban))
```


* "educ'
```{r}
ggplot(data = selectData, mapping = aes(x = educ)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Mothers' Eduction in Years",
       y = "Count")
```


* "usemeth"
```{r}
ggplot(data = selectData, mapping = aes(x = usemeth)) + 
  geom_bar(fill = "white", color = "black") +
  labs(x = "Is Usemeth",
       y = "Count")

#Find the counts of each urban type
table(selectData$urban)
#Find the proportion for each audience type
prop.table(table(selectData$urban))
```


* "agefm'
```{r}
ggplot(data = selectData, mapping = aes(x = agefm)) +
  geom_histogram(binwidth = 2, fill = "white", color = "black") +
  labs(x = "Age of First Marriage",
       y = "Count")
```



### multivariant

* 'chilren' vs. 'age'
```{r}
ggplot(data = selectData, aes(x = age, y = children)) + geom_point() + geom_smooth(method = "lm") + labs(x = "Current Age of Mother", y = "Numbers of Living Children", title = "Relationship between Children and Age")
```

According to the graph, from the smooth line, we can see that the relationship between `age` and `children` is positively related, which means the older the current age of mother is, we can assume the more numbers of living children she had.

```{r}
ggplot(data = selectData, aes(x = educ, y = children)) + geom_point() + facet_grid(.~ urban)+ geom_smooth(method = "lm") + labs(x = "The Years of Education that mother had", y = "Numbers of Living Children", title = "Relationship between Education and Children")
```

According to the graph above, we can see that the the smooth line here is negatively, which mean the relationship between `educ` and `children` is negatively related no matter the mother lived in the urban area or not. In that case, we can say that as the education that the mother had increase, we expect the number of living children that she had decrease.


```{r}
ggplot(data = selectData, aes(x = agefm, y = children)) + geom_boxplot() + facet_grid(. ~ usemeth) + labs(x = "Mother's age at first marriage", y = "Number of Living Children", title = "Relationship between children and age of first marriage")
```

According to the plot above, we can see that the mean numbers of living children that a mother had is roughly same no matter she had ever uses the birth control or not. But the highest number of children that a mother had is come from the group that never uses the birth control. What's more, the range of the numbers of living children is wider in the group that never uses the birth control, which I think we can say the mothers who had used birth control were more in control of their desired number of children.

## Assumption
### Mean = Variance

* 'age'
```{r}
cuts = cut(selectData$age,
           breaks=c(15,20,25,30,35,40,45,50))
ageGrps <- data.frame(cuts, selectData)
ggplot(data = ageGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- ageGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)
```

 
* 'educ'
```{r}
cuts = cut(selectData$educ,
           breaks=c(-1,5,10,15,20))
educGrps <- data.frame(cuts, selectData)
ggplot(data = ageGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- educGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


* 'agefm'

```{r}
cuts = cut(selectData$agefm,
           breaks=c(9, 15, 20, 25, 30, 35, 40, 45, 50))
agefmGrps <- data.frame(cuts, selectData)
ggplot(data = agefmGrps, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(cuts) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- agefmGrps  %>% group_by(cuts)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


```{r}
ggplot(data = selectData, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(selectData$urban) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- selectData  %>% group_by(urban)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```


```{r}
ggplot(data = selectData, aes(x = children)) +
  geom_histogram(binwidth = .5, color = "black", 
                 fill = "white") +
  facet_wrap(selectData$usemeth) +
  xlab("Number of Children")
```

```{r}
# Mean = Variance
table1chp4<- selectData  %>% group_by(usemeth)  %>% 
  summarise(mnNum= mean(children),varNum=var(children),n=n())
kable(table1chp4, booktabs=T, 
      caption="Compare mean and variance of number of children within each age group.",
      col.names = c("Age Groups", "Mean", "Variance", "n")) %>%
  kable_styling(full_width = F)

```

###  Checking Linearity
* age

```{r}
## Checking linearity assumption:
sumStats <- selectData %>% group_by(age) %>% 
  summarise(mnchildr = mean(children),
            logmnchildrl = log(mnchildr), n=n())
ggplot(sumStats, aes(x=age, y=logmnchildrl)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1.5)+
  xlab("Age of Mother") +
  ylab("Log of the empirical mean of the number of Children") 
```

* agefm

```{r}
## Checking linearity assumption:
sumStats <- selectData %>% group_by(agefm) %>% 
  summarise(mnchildr = mean(children),
            logmnchildrl = log(mnchildr), n=n())
ggplot(sumStats, aes(x=agefm, y=logmnchildrl)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1.5)+
  xlab("Age of Mother at First Mirrage") +
  ylab("Log of the empirical mean of the number of Children") 
```

* educ
```{r}
## Checking linearity assumption:
sumStats <- selectData %>% group_by(educ) %>% 
  summarise(mnchildr = mean(children),
            logmnchildrl = log(mnchildr), n=n())
ggplot(sumStats, aes(x=educ, y=logmnchildrl)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1.5)+
  xlab("Years of Education") +
  ylab("Log of the empirical mean of the number of Children") 
```

## Reaserch Question 1

## Reaserch Question 2

## Reaserch Question 3 

# Part2 Multilevel Model

## About data
The dataset we are going to use is created by the people over at the UCLA Institute for Digital Research and Education (IDRE). 
The dataset measures schools and teachers, as well as students. The researchers are interested in how the organizational structure of schools influences the performance of students, or how teacher characteristics such as experience, IQ, or teaching style have an impact on student learning.

Therefore, the level 1 observational unit is each student, and level 2 observational unit is school.

## Load data
```{r}
mlmdata <- read_dta("https://stats.idre.ucla.edu/stat/examples/imm/imm23.dta")
```

## Research Question

Does the time spend on math homework affect the math score?
Does the association between time spent doing homework and math score depend on the type of school?

## Parameter of Interest and Fixed Effect/Random Effect

Therefore, the parameter we are gonna use is 'homework' (Time spend on homework each week) and 'public' (1=public school, 0 = others). And our response variable is 'math'(math score for each student).

Fixed effects are the time spend on their homework and the type of schools.

Random effects are the schools.

## Parameter fine-tuning
We are not going to do any parameter tuning here.
```{r}
head(mlmdata)
str(mlmdata)
```

